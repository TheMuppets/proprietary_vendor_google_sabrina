#!/vendor/bin/sh

echo "KEY_INJECT starts"

readonly FACTORY_DIR="/mnt/vendor/factory"

# b/286621461: RPMB lock should not be enabled because there're some devices
# that do not have a working RPMB and store the credentials on the TEE
# partition. If we enable the RPMB lock and do not always provision on boot,
# these devices may lose their credentials after a wipe on TEE partition.

if [[ -d "${FACTORY_DIR}" ]]; then
  # b/245255429: always try to provision ID attestation because the attested
  # data may be incorrect after an unit is reflashed back to an older FSI build
  # in the factory.
  tee_key_inject -t 0x43 -i "${FACTORY_DIR}/android_attestation_device_id.xml"

  tee_key_inject -t 0x11 -i "${FACTORY_DIR}/wv.key"
  tee_key_inject -t 0x21 -i "${FACTORY_DIR}/pr3.key"
  tee_key_inject -t 0x22 -i "${FACTORY_DIR}/pr3.crt"
  tee_key_inject -t 0x31 -i "${FACTORY_DIR}/hdcp14tx.key"
  tee_key_inject -t 0x32 -i "${FACTORY_DIR}/hdcp22tx.key"
  tee_key_inject -t 0x42 -i "${FACTORY_DIR}/android_attestation.key" -n attestationkeybox
  tee_key_inject -t 0x61 -i "${FACTORY_DIR}/nf.key"
fi

tee_key_inject -t 0x11 -q
setprop vendor.sys.tee_key_inject_wv_key "$(( $? == 0 ? 1 : 0 ))"

tee_key_inject -t 0x21 -q
setprop vendor.sys.tee_key_inject_pr3_key "$(( $? == 0 ? 1 : 0 ))"

tee_key_inject -t 0x22 -q
setprop vendor.sys.tee_key_inject_pr3_crt "$(( $? == 0 ? 1 : 0 ))"

tee_key_inject -t 0x31 -q
setprop vendor.sys.tee_key_inject_hdcp14tx "$(( $? == 0 ? 1 : 0 ))"

tee_key_inject -t 0x32 -q
setprop vendor.sys.tee_key_inject_hdcp22tx "$(( $? == 0 ? 1 : 0 ))"

tee_key_inject -t 0x42 -q -n attestationkeybox
setprop vendor.sys.tee_key_inject_attestation_key "$(( $? == 0 ? 1 : 0 ))"

tee_key_inject -t 0x43 -q
setprop vendor.sys.tee_key_inject_attestation_device_id "$(( $? == 0 ? 1 : 0 ))"

tee_key_inject -t 0x61 -q
setprop vendor.sys.tee_key_inject_nf "$(( $? == 0 ? 1 : 0 ))"

[[ -f ${FACTORY_DIR}/client.crt ]];
setprop vendor.sys.cast_cert_provisioned "$(( $? == 0 ? 1 : 0 ))"

[[ -f ${FACTORY_DIR}/client.key ]];
setprop vendor.sys.cast_key_provisioned "$(( $? == 0 ? 1 : 0 ))"

